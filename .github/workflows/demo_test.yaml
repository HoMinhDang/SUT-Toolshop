name: Run Laravel Feature Tests 🧪

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-22.04

    env:
      SPRINT_FOLDER: sprint5-with-bugs
      DISABLE_LOGGING: true

    steps:
      - name: Checkout source code ⚙️
        uses: actions/checkout@v4

      - name: Build & start Docker containers 🐳
        run: |
          docker compose up -d

      - name: Wait for MariaDB to be ready ⏳
        run: |
          echo "Waiting for MariaDB..."
          for i in $(seq 1 30); do
            docker compose exec -T mariadb mysqladmin ping -h mariadb -u root -proot >/dev/null 2>&1 && break
            echo "Still waiting ($i)..."
            sleep 2
          done

      - name: Install PHP dependencies (composer) 📦
        run: |
          docker compose exec -T laravel-api sh -c "cd /var/www && composer install --no-dev --optimize-autoloader"

      - name: Copy test env (nếu cần) 🧪
        if: exists('${{ github.workspace }}/.env.testing')
        run: |
          docker compose exec -T laravel-api sh -c "cp /var/www/.env.testing /var/www/.env"

      - name: Run migrations & seed 🌱
        run: |
          docker compose exec -T laravel-api sh -c "cd /var/www && php artisan migrate:refresh --seed"

      - name: Run Feature Tests 🧑‍💻
        run: |
          docker compose exec -T laravel-api sh -c "cd /var/www && ./vendor/bin/phpunit --testdox --colors=always tests/Feature"

      - name: Teardown Docker containers 🧹
        if: always()
        run: |
          docker compose down -v
